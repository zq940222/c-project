# C语言数据文件处理工具 - 技术解决方案

## 1. 项目概述

### 1.1 项目背景
本项目旨在开发一套基于 **Vue + Spring Boot** 的C语言数据文件处理工具，用于处理以C语言格式存储数据的文件（如铁路车站信息管理系统中的结构体数据）。

### 1.2 核心目标
- **不是用C语言开发**，而是用Vue + Spring Boot开发一个C语言文件处理工具
- 对象：用来存放数据的C语言文件（结构体定义、变量声明等）
- 提供业务检查、数据查询、文件比对、数据修改等功能

---

## 2. 需求分析

### 2.1 文件内容特征

| 类型 | 说明 | 示例 |
|------|------|------|
| 宏定义 | `#define A` 或 `#define A B` | `#define WHITE 白色` |
| 结构体定义 | 基本数据类型结构体 | `struct 猫 {ID, 品种, 出生日期, 颜色}` |
| 结构体嵌套 | 包含其他结构体 | `struct 动物园 {猫, 狗, 老虎}` |
| 结构体变量 | 数据实例 | `猫 园区的猫们=[{小黄, 橘猫, 2023, 黄色}]` |

### 2.2 功能需求

#### 2.2.1 业务正确性检查
- 检查结果以类似IDE语法检查的形式显示
- 支持规则的增、删、改、发布管理
- 规则编写采用低代码/伪代码方式

**规则示例**：
```sql
-- 检查ID不重复
园区的猫们 ID 不重复
园区的猫们 GROUP BY ID HAVING COUNT(*) > 1

-- 检查出生日期
园区的猫们 出生日期 > 1990
```

#### 2.2.2 数据查询
```sql
SEARCH 园区的猫们
SEARCH 园区的猫们 条件 品种=狸花
```

#### 2.2.3 文件比对
- 纯文本比对基础上增加**语法和业务比对**
- **忽略编码格式差异**：`0x01` 和 `0x1` 对编译器相同
- **忽略顺序差异**：`{小黄, 小黑}` 等价于 `{小黑, 小黄}`

#### 2.2.4 数据插入和修改
```sql
修改 小黄 品种 金渐层
插入 小花 奶牛, 2025, 黑白
```

### 2.3 技术挑战

| 挑战 | 说明 |
|------|------|
| 宏定义支持 | 标准ANTLR C解析器不支持宏定义 |
| 结构体嵌套 | 需要处理复杂的嵌套关系 |
| 容错解析 | 语法错误时仍需提供部分解析结果 |
| 语义比对 | 不同于纯文本diff的语义级别比较 |

---

## 3. 技术架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端 (Vue3 + TypeScript)                  │
├─────────────────┬─────────────────┬─────────────────────────────┤
│  Monaco Editor  │   规则编辑器    │      结果展示组件            │
│  (代码编辑)     │   (低代码UI)    │   (图表/表格/关联显示)       │
└────────┬────────┴────────┬────────┴──────────────┬──────────────┘
         │                 │                       │
         ▼                 ▼                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                    后端 (Spring Boot 3.x)                        │
├─────────────────┬─────────────────┬─────────────────────────────┤
│   C语言解析服务  │    规则引擎     │       比对服务              │
│  (ANTLR4/Tree-  │   (Drools/     │    (java-diff-utils +       │
│   sitter)       │    Easy Rules)  │     语义比对)               │
├─────────────────┴─────────────────┴─────────────────────────────┤
│                      指令执行引擎                                │
│              (类SQL DSL解析和执行)                               │
├─────────────────────────────────────────────────────────────────┤
│                      数据存储层                                  │
│          (结构化数据 + 文件存储 + 规则库)                        │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 技术栈选型

#### 3.2.1 前端技术栈

| 技术 | 版本 | 用途 | 开源地址 |
|------|------|------|----------|
| Vue.js | 3.x | 前端框架 | https://github.com/vuejs/vue |
| TypeScript | 5.x | 类型安全 | https://github.com/microsoft/TypeScript |
| Vite | 5.x | 构建工具 | https://github.com/vitejs/vite |
| Monaco Editor | 0.45+ | 代码编辑器(VS Code内核) | https://github.com/microsoft/monaco-editor |
| monaco-editor-vue3 | 1.0+ | Vue3 Monaco封装 | https://github.com/bazingaedward/monaco-editor-vue3 |
| Ant Design Vue | 4.x | UI组件库 | https://github.com/vueComponent/ant-design-vue |
| ECharts | 5.x | 图表展示 | https://github.com/apache/echarts |
| Pinia | 2.x | 状态管理 | https://github.com/vuejs/pinia |

#### 3.2.2 后端技术栈

| 技术 | 版本 | 用途 | 开源地址 |
|------|------|------|----------|
| Spring Boot | 3.2+ | 后端框架 | https://github.com/spring-projects/spring-boot |
| ANTLR4 | 4.13+ | C语言解析 | https://github.com/antlr/antlr4 |
| C.g4 Grammar | - | C语言语法定义 | https://github.com/antlr/grammars-v4/tree/master/c |
| Tree-sitter (可选) | - | 增量解析 | https://github.com/tree-sitter/tree-sitter |
| java-tree-sitter | - | Java绑定 | https://github.com/seart-group/java-tree-sitter |
| Drools | 8.x | 规则引擎 | https://github.com/kiegroup/drools |
| Easy Rules | 4.1+ | 轻量规则引擎 | https://github.com/j-easy/easy-rules |
| java-diff-utils | 4.12+ | 文本比对 | https://github.com/java-diff-utils/java-diff-utils |
| MyBatis-Plus | 3.5+ | ORM框架 | https://github.com/baomidou/mybatis-plus |

#### 3.2.3 可复用低代码平台（可选集成）

| 平台 | 说明 | 开源地址 |
|------|------|----------|
| JeecgBoot | 企业级低代码平台，Vue3+Spring Boot | https://github.com/jeecgboot/JeecgBoot |
| 若依(RuoYi) | 权限管理系统 | https://github.com/yangzongzhuan/RuoYi-Vue |
| LowCodeEngine | 阿里低代码引擎 | https://github.com/alibaba/lowcode-engine |

---

## 4. 核心模块设计

### 4.1 C语言解析模块

#### 4.1.1 技术方案对比

| 方案 | 优点 | 缺点 | 推荐场景 |
|------|------|------|----------|
| **ANTLR4 + C.g4** | 成熟稳定、社区支持好、Java原生 | 不支持宏定义、无增量解析 | 标准C语法解析 |
| **Tree-sitter** | 增量解析、容错性好、速度快36x | 需要C绑定、配置复杂 | 实时编辑场景 |
| **自定义解析器** | 完全可控、支持特殊语法 | 开发成本高 | 特殊需求 |

#### 4.1.2 推荐方案：ANTLR4 + 预处理器

```
┌────────────────┐     ┌────────────────┐     ┌────────────────┐
│   C源文件      │────▶│   预处理器     │────▶│  ANTLR4解析    │
│  (含宏定义)    │     │  (宏展开)      │     │  (生成AST)     │
└────────────────┘     └────────────────┘     └────────────────┘
                                                      │
                                                      ▼
                              ┌────────────────────────────────┐
                              │        结构化数据存储          │
                              │  (变量名→值→行列结构映射)      │
                              └────────────────────────────────┘
```

#### 4.1.3 核心数据结构

```java
// 结构体定义
public class StructDefinition {
    private String name;                    // 结构体名称
    private List<FieldDefinition> fields;   // 字段列表
    private SourceLocation location;        // 源码位置
}

// 字段定义
public class FieldDefinition {
    private String name;                    // 字段名
    private String type;                    // 类型
    private Object defaultValue;            // 默认值
}

// 变量实例
public class VariableInstance {
    private String name;                    // 变量名
    private String structType;              // 结构体类型
    private Map<String, Object> values;     // 字段值
    private SourceLocation location;        // 源码位置
}

// 源码位置（用于IDE关联显示）
public class SourceLocation {
    private String filePath;
    private int startLine;
    private int endLine;
    private int startColumn;
    private int endColumn;
}
```

### 4.2 规则引擎模块

#### 4.2.1 技术选型：Drools + 自定义DSL

**选择Drools的原因**：
- 企业级BRMS，功能完善
- 支持DRL规则语言
- 支持决策表(Excel)
- 与Spring Boot集成良好

#### 4.2.2 规则DSL设计

```
┌─────────────────────────────────────────────────────────────┐
│                     用户低代码规则                          │
│  例如: 园区的猫们 ID 不重复                                 │
└─────────────────────────────────┬───────────────────────────┘
                                  │ DSL解析
                                  ▼
┌─────────────────────────────────────────────────────────────┐
│                    Drools DRL规则                           │
│  rule "ID唯一性检查"                                        │
│  when                                                       │
│      $cats: List() from collect(Cat())                      │
│      $grouped: Map() from groupBy($cats, Cat::getId)        │
│      exists(entry in $grouped where entry.getValue() > 1)   │
│  then                                                       │
│      addError("ID重复", $entry.getKey());                   │
│  end                                                        │
└─────────────────────────────────────────────────────────────┘
```

#### 4.2.3 规则类型支持

| 规则类型 | 低代码语法 | 说明 |
|----------|------------|------|
| 唯一性检查 | `变量 字段 不重复` | 检查字段值唯一 |
| 范围检查 | `变量 字段 > 值` | 检查字段范围 |
| 分组统计 | `GROUP BY ... HAVING ...` | SQL风格统计 |
| 正则匹配 | `变量 字段 MATCH 正则` | 格式校验 |
| 自定义函数 | `FUNC(参数)` | 扩展函数 |

### 4.3 查询引擎模块

#### 4.3.1 DSL语法设计

```sql
-- 基础查询
SEARCH 园区的猫们

-- 条件查询
SEARCH 园区的猫们 WHERE 品种 = '狸花'

-- 多条件
SEARCH 园区的猫们 WHERE 品种 = '狸花' AND 出生日期 > 2020

-- 排序
SEARCH 园区的猫们 ORDER BY 出生日期 DESC

-- 分页
SEARCH 园区的猫们 LIMIT 10 OFFSET 0

-- 聚合
SEARCH 园区的猫们 GROUP BY 品种 COUNT(*)
```

#### 4.3.2 查询执行流程

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  DSL输入     │───▶│  词法分析    │───▶│  语法分析    │───▶│  AST生成     │
└──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘
                                                                   │
┌──────────────┐    ┌──────────────┐    ┌──────────────┐           │
│  结果返回    │◀───│  数据过滤    │◀───│  执行计划    │◀──────────┘
└──────────────┘    └──────────────┘    └──────────────┘
```

### 4.4 比对模块

#### 4.4.1 三层比对架构

```
┌─────────────────────────────────────────────────────────────┐
│                     第一层：纯文本比对                       │
│                   (java-diff-utils)                         │
├─────────────────────────────────────────────────────────────┤
│                     第二层：语法比对                         │
│         - 忽略空白差异                                      │
│         - 忽略编码格式差异 (0x01 vs 0x1)                    │
│         - 忽略注释差异                                      │
├─────────────────────────────────────────────────────────────┤
│                     第三层：业务比对                         │
│         - 忽略顺序差异 ({A,B} = {B,A})                      │
│         - 语义等价检查                                      │
│         - 结构体字段对比                                    │
└─────────────────────────────────────────────────────────────┘
```

#### 4.4.2 比对结果类型

```java
public enum DiffType {
    ADDED,          // 新增
    REMOVED,        // 删除
    MODIFIED,       // 修改
    MOVED,          // 移动位置
    FORMAT_ONLY,    // 仅格式差异（可忽略）
    ORDER_ONLY,     // 仅顺序差异（可忽略）
    SEMANTIC_EQUAL  // 语义等价
}
```

### 4.5 数据修改模块

#### 4.5.1 修改操作类型

| 操作 | 语法 | 说明 |
|------|------|------|
| 插入 | `INSERT INTO 变量 VALUES (...)` | 新增数据项 |
| 修改 | `UPDATE 变量 SET 字段=值 WHERE ...` | 修改现有数据 |
| 删除 | `DELETE FROM 变量 WHERE ...` | 删除数据项 |

#### 4.5.2 双向同步机制

```
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│   结构化数据     │◀───▶│   同步引擎       │◀───▶│   C源代码        │
│   (内存/DB)      │     │                  │     │   (文件)         │
└──────────────────┘     └──────────────────┘     └──────────────────┘
        │                        │                        │
        │                        │                        │
        ▼                        ▼                        ▼
   数据修改操作           保持一致性               反向生成代码
```

---

## 5. 低代码UI模块

### 5.1 指令编辑器

基于 **Monaco Editor** 实现，提供：
- 语法高亮（自定义DSL语法）
- 自动补全（变量名、字段名、关键字）
- 错误提示（实时语法检查）
- 快捷操作（常用规则模板）

### 5.2 可视化规则配置

```
┌─────────────────────────────────────────────────────────────┐
│  规则名称: [ID唯一性检查     ]                              │
├─────────────────────────────────────────────────────────────┤
│  目标变量: [园区的猫们 ▼]                                   │
├─────────────────────────────────────────────────────────────┤
│  检查类型: ○ 唯一性  ○ 范围  ○ 格式  ○ 自定义              │
├─────────────────────────────────────────────────────────────┤
│  检查字段: [ID ▼]                                           │
├─────────────────────────────────────────────────────────────┤
│  生成的规则: 园区的猫们 ID 不重复                           │
├─────────────────────────────────────────────────────────────┤
│  [保存规则]  [测试规则]  [取消]                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 结果展示

| 展示类型 | 适用场景 | 组件 |
|----------|----------|------|
| 表格 | 查询结果 | Ant Design Table |
| 图表 | 统计分析 | ECharts |
| Diff视图 | 文件比对 | Monaco DiffEditor |
| 源码关联 | 错误定位 | Monaco Editor + Markers |

---

## 6. 接口设计

### 6.1 RESTful API

```yaml
# 文件解析
POST /api/parse
  - 上传C文件，返回解析后的结构化数据

# 规则管理
GET    /api/rules           - 获取规则列表
POST   /api/rules           - 创建规则
PUT    /api/rules/{id}      - 更新规则
DELETE /api/rules/{id}      - 删除规则
POST   /api/rules/execute   - 执行规则检查

# 数据查询
POST /api/query
  - 执行DSL查询，返回结果

# 文件比对
POST /api/diff
  - 比对两个文件，返回差异

# 数据修改
POST /api/modify
  - 执行INSERT/UPDATE/DELETE操作
```

### 6.2 WebSocket接口

```yaml
# 实时检查结果推送
WS /ws/check-result
  - 规则检查进度和结果实时推送

# 编辑器协同（可选）
WS /ws/editor
  - 多人协同编辑支持
```

---

## 7. 数据存储设计

### 7.1 数据库表设计

```sql
-- 结构体定义表
CREATE TABLE struct_definition (
    id BIGINT PRIMARY KEY,
    name VARCHAR(100),
    fields JSON,
    source_file VARCHAR(500),
    create_time DATETIME
);

-- 变量数据表
CREATE TABLE variable_data (
    id BIGINT PRIMARY KEY,
    struct_id BIGINT,
    name VARCHAR(100),
    data JSON,
    source_location JSON,
    create_time DATETIME
);

-- 规则定义表
CREATE TABLE rule_definition (
    id BIGINT PRIMARY KEY,
    name VARCHAR(100),
    description TEXT,
    rule_type VARCHAR(50),
    rule_content TEXT,
    drools_content TEXT,
    status VARCHAR(20),
    create_time DATETIME,
    update_time DATETIME
);

-- 检查结果表
CREATE TABLE check_result (
    id BIGINT PRIMARY KEY,
    rule_id BIGINT,
    file_path VARCHAR(500),
    result_type VARCHAR(20),
    message TEXT,
    source_location JSON,
    check_time DATETIME
);
```

---

## 8. 部署架构

### 8.1 开发环境

```
┌─────────────────┐     ┌─────────────────┐
│   Vue Dev       │────▶│  Spring Boot    │
│   (localhost:   │     │  (localhost:    │
│    5173)        │     │   8080)         │
└─────────────────┘     └─────────────────┘
                               │
                               ▼
                        ┌─────────────────┐
                        │    MySQL/H2     │
                        └─────────────────┘
```

### 8.2 生产环境

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Nginx         │────▶│  Spring Boot    │────▶│   MySQL         │
│   (静态资源+    │     │  (多实例)       │     │   (主从)        │
│    反向代理)    │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        │                       │
        │                       ▼
        │               ┌─────────────────┐
        │               │   Redis         │
        │               │   (缓存+会话)   │
        │               └─────────────────┘
        │
        ▼
┌─────────────────┐
│   Vue SPA       │
│   (构建产物)    │
└─────────────────┘
```

---

## 9. 开发计划

### 9.1 阶段划分

| 阶段 | 内容 | 优先级 |
|------|------|--------|
| **Phase 1** | C语言解析 + 基础数据展示 | P0 |
| **Phase 2** | 查询功能 + 规则引擎基础 | P0 |
| **Phase 3** | 文件比对功能 | P1 |
| **Phase 4** | 数据修改 + 反向生成 | P1 |
| **Phase 5** | 低代码UI完善 | P2 |
| **Phase 6** | IDE集成 + 协同功能 | P2 |

### 9.2 技术验证优先项

1. **ANTLR4 C语言解析验证**
   - 测试标准C文件解析
   - 评估宏定义处理方案

2. **Tree-sitter增量解析评估**
   - 测试Java绑定稳定性
   - 评估性能提升

3. **Drools规则引擎集成**
   - 验证Spring Boot集成
   - 测试自定义DSL转换

---

## 10. 开源组件汇总

### 10.1 必选组件

| 组件 | 用途 | 许可证 | 链接 |
|------|------|--------|------|
| ANTLR4 | 语法解析 | BSD-3 | [GitHub](https://github.com/antlr/antlr4) |
| grammars-v4/c | C语法定义 | BSD-3 | [GitHub](https://github.com/antlr/grammars-v4/tree/master/c) |
| Drools | 规则引擎 | Apache-2.0 | [GitHub](https://github.com/kiegroup/drools) |
| java-diff-utils | 文本比对 | Apache-2.0 | [GitHub](https://github.com/java-diff-utils/java-diff-utils) |
| Monaco Editor | 代码编辑器 | MIT | [GitHub](https://github.com/microsoft/monaco-editor) |
| monaco-editor-vue3 | Vue封装 | MIT | [GitHub](https://github.com/bazingaedward/monaco-editor-vue3) |

### 10.2 可选组件

| 组件 | 用途 | 许可证 | 链接 |
|------|------|--------|------|
| Tree-sitter | 增量解析 | MIT | [GitHub](https://github.com/tree-sitter/tree-sitter) |
| java-tree-sitter | Java绑定 | MIT | [GitHub](https://github.com/seart-group/java-tree-sitter) |
| Easy Rules | 轻量规则 | MIT | [GitHub](https://github.com/j-easy/easy-rules) |
| JeecgBoot | 低代码平台 | Apache-2.0 | [GitHub](https://github.com/jeecgboot/JeecgBoot) |

---

## 11. 风险与对策

| 风险 | 影响 | 对策 |
|------|------|------|
| ANTLR不支持宏定义 | 无法解析含宏的文件 | 实现预处理器进行宏展开 |
| 嵌套结构体复杂 | 数据结构映射困难 | 递归解析+扁平化存储 |
| 语义比对准确性 | 误报/漏报 | 多层比对+用户确认 |
| 规则DSL学习成本 | 用户难以上手 | 可视化配置+模板库 |
| 大文件性能 | 解析/比对缓慢 | 增量解析+异步处理 |

---

## 12. 参考资料

- [ANTLR4 官方文档](https://www.antlr.org/)
- [Tree-sitter 官方文档](https://tree-sitter.github.io/tree-sitter/)
- [Drools 官方文档](https://www.drools.org/)
- [Monaco Editor API](https://microsoft.github.io/monaco-editor/api/index.html)
- [Spring Boot 3.x 文档](https://spring.io/projects/spring-boot)
- [Vue 3 官方文档](https://vuejs.org/)

---

*文档版本: v1.0*
*创建日期: 2025-12-26*
